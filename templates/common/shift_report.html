{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block content %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">

<!-- DataTables JS -->
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>

<!-- TableExport library -->
<script type="text/javascript" src="https://unpkg.com/tableexport@5.2.3/dist/js/tableexport.min.js"></script>

<!-- jsPDF library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

<script src="    https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.6/jspdf.plugin.autotable.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

   <!--  <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl " id="navbarBlur"
        data-scroll="false">
        <div class="container-fluid py-1 px-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
                    <li class="breadcrumb-item text-sm"><a class="opacity-5 text-white" href="javascript:;">Home</a>
                    </li>
                    <li class="breadcrumb-item text-sm text-white active" aria-current="page">Shift Report</li>
                </ol>

            </nav>
            <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
                <div class="ms-md-auto pe-md-3 d-flex align-items-center">
                   
                </div>
                <ul class="navbar-nav  justify-content-end">
                    <li class="nav-item d-flex align-items-center">
                        <a href="{% url 'logout' %}" class="nav-link text-white font-weight-bold px-0">
                            <i class="fa fa-sign-out me-sm-1"></i>
                            <span class="d-sm-inline d-none">Logout</span>
                        </a>
                    </li>
                    <li class="nav-item d-xl-none ps-3 d-flex align-items-center ">
                        <a href="javascript:;" class="nav-link text-white p-0" id="iconNavbarSidenav">
                            <div class="sidenav-toggler-inner">
                                <i class="sidenav-toggler-line bg-white"></i>
                                <i class="sidenav-toggler-line bg-white"></i>
                                <i class="sidenav-toggler-line bg-white"></i>
                            </div>
                        </a>
                    </li>

                    <li class="nav-item dropdown pe-2 px-3 d-flex align-items-center">
                        <a href="javascript:;" class="nav-link text-white p-0" id="dropdownMenuButton"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa fa-user cursor-pointer"><span class="mx-2 ">{{user.username}}</span></i>
                        </a>
                        <ul class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4"
                            aria-labelledby="dropdownMenuButton">
                            <li class="mb-2">
                                <a class="dropdown-item border-radius-md" href="{% url 'profile' %}">
                                    <div class="d-flex py-1">
                                        <div class="my-auto">
                                            <i class="fa fa-user cursor-pointer pe-3" class="avatar avatar-sm  me-3 "></i>
                                        </div>
                                        <div class="d-flex flex-column justify-content-center">
                                            <h6 class="text-sm font-weight-normal mb-1">
                                                <span class="font-weight-bold">Profile</span>
                                            </h6>
                                        </div>
                                    </div>
                                </a>
                            </li>
                            <li class="mb-2">
                                <a class="dropdown-item border-radius-md" href="{% url 'change-password'%}">
                                    <div class="d-flex py-1">
                                        <div class="my-auto">
                                            <i class="fa fa-key cursor-pointer pe-3" class="avatar avatar-sm  me-3 "></i>
                                        </div>
                                        <div class="d-flex flex-column justify-content-center">
                                            <h6 class="text-sm font-weight-normal mb-1">
                                                <span class="font-weight-bold">Change Password</span>
                                            </h6>
                                        </div>
                                    </div>
                                </a>
                            </li>
                        
                        
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- Begin Page Content -->
    <div class="container-fluid mt-5">
        <!-- Main Content Here -->
        <div class="row">
            <div class="col-xl-2 col-md-2 col-sm-5 mb-xl-0 mb-5">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="numbers">
                           
                                    <form method="post" action="{% url 'shift_report' %}">
                                        {% csrf_token %}
                                        {{ form.location }}
                                        {{ form.dpu }}
                                        {% csrf_token %}
                                        <!-- Dropdowns for selecting filters -->
                                        <label for="location" class="text-sm mb-0 text-uppercase fw-bold">Root</label>
                                        <p class="float-end fw-bold">
                                            Total - <code><strong>{{ total_locations }}</strong></code>
                                        </p>
                                        <select name="location" id="location" class="form-select rounded" >                                              
                                            {% for loc in locations %}
                                                <option value="{{ loc }}" {% if selected_location == loc %} selected {% endif %}>{{ loc }}</option>
                                            {% endfor %}                             
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-2 col-md-2 col-sm-5 mb-xl-0 mb-5">
                            <div class="card">
                                <div class="card-body p-3">
                                    <div class="numbers">
                                        <label for="dpu" class="text-sm mb-0 text-uppercase fw-bold">DPU</label>
                                        <p class="float-end fw-bold">
                                            Total - <code><strong>{{total_dpus}}</strong></code>
                                        </p>
                                        <select name="dpu" id="dpu" class="form-select rounded">
                                            {% for d in dpus %}
                                                <option value="{{ d }}" {% if selected_dpu == d %} selected {% endif %}>{{ d }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-2 col-md-2 col-sm-5 mb-xl-0 mb-5">
                            <div class="card">
                                <div class="card-body p-3">
                                    <div class="numbers">
                                        
                                        <label for="society" class="text-sm mb-0 text-uppercase fw-bold">Society </label>
                                        <p class="float-end fw-bold">
                                            Total - <code><strong>{{total_societies}}</strong></code>
                                        </p>
                                            <select name="society" id="society" class="form-select rounded">
                                                {% for s in societies %}
                                                    <option value="{{ s }}" {% if selected_society == s %} selected {% endif %}>{{ s }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-2 col-md-2 col-sm-5 mb-xl-0 mb-5">
                                <div class="card">
                                    <div class="card-body p-3">
                                        <div class="numbers">
                                            <label for="shift" class="text-sm mb-0 text-uppercase fw-bold">Select Shift:</label>
                                                <select name="shift" id="shift" class="form-select rounded">
                                                    {% for sh in shifts %}
                                                        <option value="{{ sh }}" {% if selected_shift == sh %} selected {% endif %}>{{ sh }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                </div>
                            </div>
                            <div class="col-xl-2 col-md-2 col-sm-5 mb-xl-0 mb-5">
                                <div class="card">
                                    <div class="card-body p-3">
                                        <div class="numbers">
                                            <label for="start_date" class="text-sm mb-0 text-uppercase fw-bold">
                                                Start Date:
                                            </label>
                                            <div class="input-group">
                                                <input type="date" name="start_date" id="start_date" class="form-control rounded" placeholder="dd/mm/yyyy" value="{{ selected_start_date }}" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-2 col-md-2 col-sm-5 mb-xl-0 mb-5">
                                <div class="col-12">
                                    <form>
                                        <div class="col-12 mb-3 mt-3">
                                            <button type="submit" class="btn btn-success">Generate Shift Report</button>
                                        </div>
                                            <!-- Hidden input to store the selected DPU value -->
    <input type="hidden" name="selected_dpu" id="selected_dpu">

                                    </form>
                                   
                                </div>
                            </div>
                    
                          
    </div>
        <!-- Total Summary Record -->
<div class="row mt-4" id="divID">
    <div class="col-lg-12 mb-lg-0 mb-5" id="myRefreshDiv">
        <div class="card">
            <div class="card-header pb-0 p-3">
                <div class="d-flex justify-content-between">
                    <h6 class="mb-2">Summary Table</h6>
                    <div class="float-end">                    
                        <button class="btn btn-primary btn-sm" onclick="exportToCsvAndPdf(['summaryTable_report', 'detailTable_report'], 'shift_report', 'csv')">CSV</button>
                        <button class="btn btn-primary btn-sm" onclick="exportToCsvAndPdf(['summaryTable_report', 'detailTable_report'], 'shift_report', 'pdf')">PDF</button>

                    </div>
                </div>
            </div>
            <div class="table-responsive card-body">
                {% if summary_data %}
                <!-- Table 1: Summary Data -->
                <table id="summaryTable_report" class="table align-items-center text-center table table-striped table-hover rounded table-responsive w-100">
                    <thead class="text-white text-center rounded table-title">
                        <tr>
                            <th>Location</th>
                            <th>DPU</th>
                            <th>Society</th>
                            <th>Date</th>
                            <th>Shift</th>
                            <th>Total Customer</th>
                            <th>Total QT.</th>
                            <th>Total Amount</th>
                            <th>Total CAmount</th>
                            <th>Avg.FAT</th>
                            <th>Avg.SNF</th>
                            <th>Avg.CLR</th>  
                        </tr>
                    </thead>
                    <tbody class=" align-items-center text-center">
                        <tr>
                            <td>{{ selected_location }}</td>
                            <td> {{ selected_dpu }}</td>
                            <td>{{ selected_society }}</td>
                            <td>{{ selected_start_date}}</td>
                            <td>{{ selected_shift }}</td>
                            <td>{{ summary_data.TotalCustomer }}</td>
                            <td>{{ summary_data.TotalQT }}</td>
                            <td>{{ summary_data.TotalAmount }}</td>
                            <td>{{ summary_data.TotalCAmount }}</td>
                            <td>{{ summary_data.AvgFAT }}</td>
                            <td>{{ summary_data.AvgSNF }}</td>
                            <td>{{ summary_data.AvgCLR }}</td>  

                        </tr>
                    </tbody>
                </table>
            {% else %}
                <p>No data available for the selected filters.</p>
            {% endif %}
            </div>
        </div>
    </div>
</div>


<!-- Table 2: Detail Data -->
<div class="row mt-4" id="divID">
    <div class="col-lg-12 mb-lg-0 mb-5" id="myRefreshDiv">
        <div class="card">
            <div class="card-header pb-0 p-3">
                <div class="d-flex justify-content-between">
                    <h6 class="mb-2">Detail Table</h6>
                </div>
            </div>
            <div class="table-responsive card-body">
                {% if detail_data %}                
                <!-- Table 1: Summary Data -->
                <table id="detailTable_report" class="table align-items-center text-center table table-striped table-hover rounded table-responsive w-100">
                    <thead class="text-white text-center rounded table-title">
                        <tr>
                            <th>CUST_ID</th>
                            <th>Customer Name</th>  <!-- Add the header for Customer Name -->

                            <th>MType</th>
                            <th>FAT</th>
                            <th>SNF</th>
                            <th>CLR</th>
                            <th>WATER</th>
                            <th>QT</th>
                            <th>RATE</th>
                            <th>Amount</th>
                            <th>CAmount</th>
                        </tr>
                    </thead>
                    <tbody class=" align-items-center text-center">
                        {% for record in detail_data %}
                            <tr>
                                <td>{{ record.CUST_ID }}</td>
                                <td>
                                    {% for customer in customer_list %}
                                        {% if customer.cust_id == record.CUST_ID and customer.st_id == selected_st_id %}
                                            {{ customer.name }}
                                        {% endif %}
                                    {% endfor %}
                                </td>
                                <td>{{ record.MType }}</td>
                                <td>{{ record.FAT }}</td>
                                <td>{{ record.SNF }}</td>
                                <td>{{ record.CLR }}</td>
                                <td>{{ record.WATER }}</td>
                                <td>{{ record.QT }}</td>
                                <td>{{ record.RATE }}</td>
                                <td>{{ record.Amount }}</td>
                                <td>{{ record.CAmount }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
              
            {% else %}
                <p>No detailed data available for the selected filters.</p>
            {% endif %}
           
            </div>
        </div>
    </div>
</div>



  <!-- JavaScript for exporting -->
<script>
    function exportToCsvAndPdf(tableIds, fileNamePrefix, format) {
        const username = '{{ user.username }}';
        const csvData = [];
        const pdf = new jsPDF();

        tableIds.forEach((tableId, index) => {
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tr');
            const tableData = [];

            rows.forEach((row) => {
                const rowData = [];
                const cells = row.querySelectorAll('td, th');
                cells.forEach((cell) => {
                    rowData.push(cell.innerText);
                });
                tableData.push(rowData.join(','));
            });

            csvData.push(tableData.join('\n'));

            if (index > 0) {
                pdf.addPage();  // Add a new page for each additional table in PDF
            }

            pdf.autoTable({ html: `#${tableId}` });
        });

        const fullFileName = `${username}_${fileNamePrefix}`;

        if (format === 'csv') {
            const csvBlob = new Blob([csvData.join('\n')], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(csvBlob);
            link.download = `${fullFileName}.csv`;
            link.click();
        } else if (format === 'pdf') {
            pdf.save(`${fullFileName}.pdf`);
        }
    }
</script>
<script>
    new DataTable('#summaryTable_report');
    new DataTable('#detailTable_report');

</script>
<!-- JavaScript to update the hidden input with the selected DPU value -->
<script>
    function getSelectedDPU() {
        // Get the selected DPU from the dropdown
        var selectedDPU = document.getElementById('dpu').value;

        // Update the hidden input with the selected DPU value
        document.getElementById('selected_dpu').value = selectedDPU;

        // Continue with the form submission
        return true;
    }




    
</script>
<!-- Add this script to handle AJAX requests -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
      const locationSelect = document.getElementById('id_location');
      const dpuSelect = document.getElementById('id_dpu');
      const societySelect = document.getElementById('id_society');
  
      locationSelect.addEventListener('change', function () {
        const selectedLocation = locationSelect.value;
  
        fetch(`/get_dpus_by_location/?location=${selectedLocation}`)
          .then(response => response.json())
          .then(data => {
            // Update DPU dropdown options
            dpuSelect.innerHTML = '';
            data.forEach(dpu => {
              const option = document.createElement('option');
              option.value = dpu;
              option.text = dpu;
              dpuSelect.add(option);
            });
  
            // Trigger change event to update the Society dropdown based on the selected DPU
            dpuSelect.dispatchEvent(new Event('change'));
          });
      });
  
      dpuSelect.addEventListener('change', function () {
        const selectedLocation = locationSelect.value;
        const selectedDpu = dpuSelect.value;
  
        fetch(`/get_societies_by_dpu/?location=${selectedLocation}&dpu=${selectedDpu}`)
          .then(response => response.json())
          .then(data => {
            // Update Society dropdown options
            societySelect.innerHTML = '';
            data.forEach(society => {
              const option = document.createElement('option');
              option.value = society;
              option.text = society;
              societySelect.add(option);
            });
          });
      });
    });
  </script>
  
  <!-- ... (existing form code) -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const locationSelect = document.getElementById('id_location');
      const dpuSelect = document.getElementById('id_dpu');
      const societySelect = document.getElementById('id_society');
  
      locationSelect.addEventListener('change', function () {
        const selectedLocation = locationSelect.value;
  
        fetch(`/get_dpus_by_location/?location=${selectedLocation}`)
          .then(response => response.json())
          .then(data => {
            // Update DPU dropdown options
            dpuSelect.innerHTML = '';
            data.forEach(dpu => {
              const option = document.createElement('option');
              option.value = dpu;
              option.text = dpu;
              dpuSelect.add(option);
            });
  
            // Trigger change event to update the Society dropdown based on the selected DPU
            dpuSelect.dispatchEvent(new Event('change'));
          });
      });
  
      dpuSelect.addEventListener('change', function () {
        const selectedLocation = locationSelect.value;
        const selectedDpu = dpuSelect.value;
  
        fetch(`/get_societies_by_dpu/?location=${selectedLocation}&dpu=${selectedDpu}`)
          .then(response => response.json())
          .then(data => {
            // Update Society dropdown options
            societySelect.innerHTML = '';
            data.forEach(society => {
              const option = document.createElement('option');
              option.value = society;
              option.text = society;
              societySelect.add(option);
            });
          });
      });
    });
  </script>
  
{% endblock content %}


    